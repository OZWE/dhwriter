define(["jquery","aloha/pluginmanager"],function(e,t){"use strict";function i(){var t=e.browser,n=t.version;return!(t.webkit&&!t.chrome&&parseFloat(n)<532.5||t.mozilla&&parseFloat(n)<1.9||t.msie&&n<7||t.opera&&n<11)}function s(t){var n=e(t.target);return n.is(".aloha-dialog")||n.closest(".aloha").length}function o(){e("html").mousedown(function(e){r.activeEditable&&!r.eventHandled&&!s(e)&&r.deactivateEditable()}).mouseup(function(){r.eventHandled=!1})}function u(t,n){var s,u;if(!i()){s=window.console;if(s){u=s.error?"error":s.log?"log":null;u&&s[u]("This browser is not supported")}return}e.browser.webkit?e("html").addClass("aloha-webkit"):e.browser.opera?e("html").addClass("aloha-opera"):e.browser.msie?e("html").addClass("aloha-ie"+parseInt(e.browser.version,10)):e.browser.mozilla&&e("html").addClass("aloha-mozilla");navigator.appVersion.indexOf("Win")!==-1?r.OSName="Win":navigator.appVersion.indexOf("Mac")!==-1?r.OSName="Mac":navigator.appVersion.indexOf("X11")!==-1?r.OSName="Unix":navigator.appVersion.indexOf("Linux")!==-1&&(r.OSName="Linux");o();r.settings.base=r.getAlohaUrl();r.Log.init();r.settings.errorhandling&&(window.onerror=function(e,t,n){r.Log.error(r,"Error message: "+e+"\nURL: "+t+"\nLine Number: "+n);return!0});t();n()}function a(e,t){r.RepositoryManager.init();e();t()}function f(e,n){var i,s,o;if(0===r.loadedPlugins.length){i=t.plugins;for(s in i)i.hasOwnProperty(s)&&r.loadedPlugins.push(s)}o=!1;t.init(function(){if(!o){e();o=!0}n()},r.loadedPlugins);if(!o){e();o=!0}}function l(e,t){var n;for(n=0;n<r.editables.length;n++)r.editables[n].ready||r.editables[n].init();e();t()}var n,r=window.Aloha;n=[{fn:null,event:null,deferred:null},{fn:u,event:null,deferred:null},{fn:a,event:null,deferred:null},{fn:f,event:"aloha-plugins-loaded",deferred:null},{fn:l,event:null,deferred:null},{fn:null,event:"aloha-ready",deferred:null}];e.extend(!0,r,{version:"${version}",editables:[],activeEditable:null,settings:{},defaults:{},ui:{},OSName:"Unknown",loadedPlugins:[],_pluginBaseUrlByName:{},init:function(){r.initialize(n)},getLoadedPlugins:function(){return this.loadedPlugins},isPluginLoaded:function(t){var n=!1;e.each(this.loadedPlugins,function(e,r){if(t===r.toString()){n=!0;return!1}});return n},activateEditable:function(e){var t,n=r.editables;for(t=0;t<n.length;t++)n[t]!==e&&n[t].isActive&&n[t].blur();r.activeEditable=e},getActiveEditable:function(){return r.activeEditable},deactivateEditable:function(){if(r.activeEditable){r.activeEditable.blur();r.activeEditable=null}},getEditableById:function(t){var n,i=e("#"+t);i.length&&"textarea"===i[0].nodeName.toLowerCase()&&(t+="-aloha");for(n=0;n<r.editables.length;n++)if(r.editables[n].getId()===t)return r.editables[n];return null},isEditable:function(e){var t,n;for(t=0,n=r.editables.length;t<n;t++)if(r.editables[t].originalObj.get(0)===e)return!0;return!1},getEditableHost:function(){var e=function(e){var t;for(t=0;t<r.editables.length;t++)if(r.editables[t].originalObj[0]===e)return r.editables[t];return null};return function(t){var n;if(!t||0===t.length)return null;n=e(t[0]);n||t.parents().each(function(t,r){n=e(r);if(n)return!1});return n}}(),log:function(e,t,n){typeof r.Log!="undefined"&&r.Log.log(e,t,n)},registerEditable:function(e){r.editables.push(e)},unregisterEditable:function(t){var n=e.inArray(t,r.editables);n!==-1&&r.editables.splice(n,1)},isModified:function(){var e;for(e=0;e<r.editables.length;e++)if(r.editables[e].isModified&&r.editables[e].isModified())return!0;return!1},getAlohaUrl:function(){return r.settings.baseUrl||""},getPluginUrl:function(e){var t;if(!e)return null;t=r.settings._pluginBaseUrlByName[e];t&&(t.match("^(/|http[s]?:).*")||(t=r.getAlohaUrl()+"/"+t));return t},disableObjectResizing:function(){var e;try{try{e=document.queryCommandSupported("enableObjectResizing")}catch(t){e=!1;r.Log.log("enableObjectResizing is not supported.")}if(e){document.execCommand("enableObjectResizing",!1,!1);r.Log.log("enableObjectResizing disabled.")}}catch(n){r.Log.error(n,"Could not disable enableObjectResizing")}},toString:function(){return"Aloha"}});return r});