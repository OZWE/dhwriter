define(["jquery","aloha/core","aloha/plugin","aloha/command","contenthandler/contenthandler-utils","aloha/console","aloha/copypaste"],function(e,t,n,r,i,s,o){"use strict";function p(e){var t=o.getEditableAt(e);t&&t.obj.focus();o.setSelectionAt(e)}function d(e,t){var n;t.css({top:a.scrollTop(),left:a.scrollLeft()-200}).contents().remove();n=o.getEditableAt(e);n&&n.obj.blur();o.setSelectionAt({startContainer:t[0],endContainer:t[0],startOffset:0,endOffset:0});t.focus()}function v(e){var t=e.startContainer;return 1===t.nodeType?"p"===t.nodeName.toLowerCase()&&i.isProppedParagraph(t.outerHTML):3===t.nodeType&&"p"===t.parentNode.nodeName.toLowerCase()&&1===t.parentNode.childNodes.length&&l.test(window.escape(t.data))}function m(e){if(v(e)){3===e.startContainer.nodeType?e.startContainer.data="":e.startContainer.innerHTML=" ";e.startOffset=0;e.endContainer===e.startContainer&&(e.endOffset=0)}}function g(e,n,r){var i;if(n){i=e.html();f&&/^&nbsp;/.test(i)&&(i=i.substring(6));p(n);if(i.indexOf("webkit-fake-url://")!=-1)return;m(n);t.queryCommandSupported("insertHTML")?t.execCommand("insertHTML",!1,i):s.error("Common.Paste",'Command "insertHTML" not available. Enable the plugin "common/commands".')}e.contents().remove();typeof r=="function"&&r()}function y(e,n,r){e.metaKey=null;e.stopPropagation();window.setTimeout(function(){g(c,n,r);t.activeEditable.smartContentChange(e)},10)}function b(e){f?e.bind("beforepaste",function(e){h=o.getRange();d(h,c);e.stopPropagation()}):e.bind("paste",function(e){var t,n=o.getRange();d(n,c);if(f){t=document.selection.createRange();t.execCommand("paste")}y(e,n)})}var u,a=e(window),f=!!e.browser.msie,l=/^(\s|%A0)$/,c=e('<div style="position:absolute; clip:rect(0px,0px,0px,0px); width:1px; height:1px;"></div>').contentEditable(!0),h=null;u=n.create("paste",{settings:{},init:function(){e("body").append(c);var n=!this.settings.noclipboardaccess;t.bind("aloha-editable-created",function(e,t){b(t.obj,n)});f&&c.bind("paste",function(e){y(e,h,function(){h=null})})},register:function(e){s.deprecated("Plugins.Paste","register() for pasteHandler is deprecated.  Use the ContentHandler Plugin instead.")}});return u});