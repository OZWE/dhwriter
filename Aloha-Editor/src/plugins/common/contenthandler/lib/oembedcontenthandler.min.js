define(["aloha","jquery","aloha/contenthandlermanager"],function(e,t,n){"use strict";function l(e,t){var n,r=e.apiendpoint,i="",s=e.callbackparameter||"callback";r.indexOf("?")<=0?r+="?":r+="&";e.maxWidth!=null&&e.params["maxwidth"]==null&&(e.params.maxwidth=e.maxWidth);e.maxHeight!=null&&e.params["maxheight"]==null&&(e.params.maxheight=e.maxHeight);for(n in e.params){if(n==e.callbackparameter)continue;e.params[n]!=null&&(i+="&"+f(n)+"="+e.params[n])}r+="format=json&url="+f(t)+i+"&"+s+"=?";return r}function c(e,n,r){var i=l(r,n),o=t.extend({url:i,type:"get",dataType:"json",success:function(r){var i=t.extend({},r);switch(i.type){case"photo":i.code=t.fn.oembed.getPhotoCode(n,i);break;case"video":i.code=t.fn.oembed.getVideoCode(n,i);break;case"rich":i.code=t.fn.oembed.getRichCode(n,i);break;default:i.code=t.fn.oembed.getGenericCode(n,i)}s.beforeEmbed.call(e,i);s.onEmbed.call(e,i);s.afterEmbed.call(e,i)},error:s.onError.call(e,n,r)},s.ajaxOptions||{});t.ajax(o)}function h(){var e,n,r,i;o=[];n=[];if(!d(s.allowedProviders)){for(r=0;r<t.fn.oembed.providers.length;r++)t.inArray(t.fn.oembed.providers[r].name,s.allowedProviders)>=0&&o.push(t.fn.oembed.providers[r]);s.greedy=!1}else o=t.fn.oembed.providers;if(!d(s.disallowedProviders)){for(r=0;r<o.length;r++)t.inArray(o[r].name,s.disallowedProviders)<0&&n.push(o[r]);o=n;s.greedy=!1}d(s.customProviders)||t.each(s.customProviders,function(e,n){if(n instanceof t.fn.oembed.OEmbedProvider)o.push(i);else{i=new t.fn.oembed.OEmbedProvider;i.fromJSON(n)&&o.push(i)}});e=p(s.defaultOEmbedProvider);s.greedy==1&&o.push(e);for(r=0;r<o.length;r++)o[r].apiendpoint==null&&(o[r].apiendpoint=e.apiendpoint)}function p(e){var n="http://oohembed.com/oohembed/";e=="embed.ly"&&(n="http://api.embed.ly/v1/api/oembed?");return new t.fn.oembed.OEmbedProvider(e,null,null,n,"callback")}function i(e){var t,n;if(e==null)return null;n={};for(t in e)t!=null&&(n[t.toLowerCase()]=e[t]);return n}function d(e){return typeof e=="undefined"?!0:e==null?!0:t.isArray(e)&&e.length==0?!0:!1}var r,i,s,o,u,a=window.GENTICS,f=window.escape;t.fn.oembed=function(e,n,r){s=t.extend(!0,t.fn.oembed.defaults,n);h();return this.each(function(){var n,o=t(this),u=e!=null?e:o.attr("href");r?s.onEmbed=r:s.onEmbed=function(e){t.fn.oembed.insertCode(this,s.embedMethod,e)};if(u!=null){n=t.fn.oembed.getOEmbedProvider(u);if(n!=null){n.params=i(s[n.name])||{};n.maxWidth=s.maxWidth;n.maxHeight=s.maxHeight;c(o,u,n)}else s.onProviderNotFound.call(o,u)}return o})};o=[];t.fn.oembed.defaults={maxWidth:null,maxHeight:null,embedMethod:"replace",defaultOEmbedProvider:"oohembed",allowedProviders:null,disallowedProviders:null,customProviders:null,defaultProvider:null,greedy:!0,onProviderNotFound:function(){},beforeEmbed:function(){},afterEmbed:function(){},onEmbed:function(){},onError:function(){},ajaxOptions:{}};t.fn.oembed.embedCode=!1;t.fn.oembed.insertCode=function(e,n,r){var i;if(r==null)return;t.fn.oembed.embedCode=r.code;switch(n){case"auto":e.attr("href")!=null?t.fn.oembed.insertCode(e,"append",r):t.fn.oembed.insertCode(e,"replace",r);break;case"replace":e.replaceWith(r.code);break;case"fill":e.html(r.code);break;case"append":i=e.next();if(i==null||!i.hasClass("oembed-container")){i=e.after('<div class="oembed-container"></div>').next(".oembed-container");r!=null&&r.provider_name!=null&&i.toggleClass("oembed-container-"+r.provider_name)}i.html(r.code)}};t.fn.oembed.getInsertCode=function(e,t,n){if(n==null)return;return n.code};t.fn.oembed.getPhotoCode=function(e,t){var n,r=t.title?t.title:"";r+=t.author_name?" - "+t.author_name:"";r+=t.provider_name?" - "+t.provider_name:"";n='<div><a href="'+e+"\" target='_blank'><img src=\""+t.url+'" alt="'+r+'"/></a></div>';t.html&&(n+="<div>"+t.html+"</div>");return n};t.fn.oembed.getVideoCode=function(e,t){var n=t.html;return n};t.fn.oembed.getRichCode=function(e,t){var n=t.html;return n};t.fn.oembed.getGenericCode=function(e,t){var n=t.title!=null?t.title:e,r='<a href="'+e+'">'+n+"</a>";t.html&&(r+="<div>"+t.html+"</div>");return r};t.fn.oembed.isProviderAvailable=function(e){var t=r(e);return t!=null};t.fn.oembed.getOEmbedProvider=function(e){var t;for(t=0;t<o.length;t++)if(o[t].matches(e))return o[t];return null};t.fn.oembed.OEmbedProvider=function(e,n,r,i,s){function f(e){return d(e)?["."]:t.isArray(e)?e:e.split(";")}var o,u,a;this.name=e;this.type=n;this.urlschemes=f(r);this.apiendpoint=i;this.callbackparameter=s;this.maxWidth=500;this.maxHeight=400;this.matches=function(e){for(o=0;o<this.urlschemes.length;o++){a=new RegExp(this.urlschemes[o],"i");if(e.match(a)!=null)return!0}return!1};this.fromJSON=function(e){for(u in e)u!="urlschemes"?this[u]=e[u]:this[u]=f(e[u]);return!0}};t.fn.oembed.providers=[new t.fn.oembed.OEmbedProvider("youtube","video",["youtube\\.com/watch.+v=[\\w-]+&?"]),new t.fn.oembed.OEmbedProvider("flickr","photo",["flickr\\.com/photos/[-.\\w@]+/\\d+/?"],"http://flickr.com/services/oembed","jsoncallback"),new t.fn.oembed.OEmbedProvider("viddler","video",["viddler.com"]),new t.fn.oembed.OEmbedProvider("blip","video",["blip\\.tv/.+"],"http://blip.tv/oembed/"),new t.fn.oembed.OEmbedProvider("hulu","video",["hulu\\.com/watch/.*"],"http://www.hulu.com/api/oembed.json"),new t.fn.oembed.OEmbedProvider("vimeo","video",["http://www.vimeo.com/groups/.*/videos/.*","http://www.vimeo.com/.*","http://vimeo.com/groups/.*/videos/.*","http://vimeo.com/.*"],"http://vimeo.com/api/oembed.json"),new t.fn.oembed.OEmbedProvider("dailymotion","video",["dailymotion\\.com/.+"]),new t.fn.oembed.OEmbedProvider("scribd","rich",["scribd\\.com/.+"]),new t.fn.oembed.OEmbedProvider("slideshare","rich",["slideshare.net"],"http://www.slideshare.net/api/oembed/1"),new t.fn.oembed.OEmbedProvider("photobucket","photo",["photobucket\\.com/(albums|groups)/.*"],"http://photobucket.com/oembed/")];u=n.createHandler({handleContent:function(e){typeof e=="string"?e=t("<div>"+e+"</div>").get(0):e instanceof t&&(e=t("<div>").append(e).get(0));e=t(e).oembed(t(e).text(),{embedMethod:"replace"});var n=setTimeout(function(){e=t.fn.oembed.embedCode;return t("<div>").append(e).html()},500)},replaceoEmbedContent:function(e){}});return u});