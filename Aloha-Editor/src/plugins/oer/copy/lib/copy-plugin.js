(function(){define(["aloha","aloha/plugin","jquery","ui/ui","ui/button","PubSub","./path","css!copy/css/copy.css"],function(e,t,n,r,i,s,o){var u="",a=null;return t.create("copy",{getCurrentPath:function(){return this.settings.path?this.settings.path():null},getBuffer:function(){return localStorage?localStorage.alohaOerCopyBuffer:u},getSrcPath:function(){return localStorage?localStorage.alohaOerCopySrcPath:a},buffer:function(e,t){var n;u=e;u=u.replace(/id="[^"]+"/,"");a=t;localStorage&&(localStorage.alohaOerCopyBuffer=u);localStorage&&(localStorage.alohaOerCopySrcPath=a);this.copybutton.disable();this.pastebutton.enable();return typeof (n=this.pastebutton).flash=="function"?n.flash():void 0},copySection:function(e){var t,r,i,s,o,u=["h1","h2","h3"],a=u.indexOf(e[0].nodeName.toLowerCase()),f=u.slice(0,a+1).join(",");e.addBack?e=e.nextUntil(f).addBack():e=e.nextUntil(f).andSelf();r="";for(s=0,o=e.length;s<o;s++){t=e[s];r+=n(t).outerHtml()}i=this.getCurrentPath();return i!==null?this.buffer(r,i):this.buffer(r)},init:function(){var t,u,f=this,l=this;n("body").on("enable-action",".action.paste,.action.copy",function(e){e.preventDefault();return n(this).prop("disabled",!1)}).on("disable-action",".action.paste,.action.copy",function(e){e.preventDefault();return n(this).prop("disabled",!0)});u=null;s.sub("aloha.selection.context-change",function(e){if(e.range.startOffset===e.range.endOffset&&n(e.range.startContainer).parents("h1,h2,h3").length){u=n(e.range.startContainer).parents("h1,h2,h3").first();return f.copybutton.enable()}return f.copybutton.disable()});this.pastebutton=r.adopt("paste",i,{tooltip:"Paste",click:function(t){var r,i,s;t.preventDefault();s=e.Selection.getRangeObject();r=n(l.getBuffer());i=l.getCurrentPath();if(i!==null){i=o.dirname(i);a=o.dirname(l.getSrcPath());if(a!==i){console.log("Rewriting images, src="+a+", dst="+i);r.find("img").each(function(e,t){var r,s,u=n(t).attr("data-src");if(!o.isabs(u)){s=o.normpath(a+"/"+u);r=o.relpath(s,i);console.log("Rewriting "+u);console.log("Absolute location is "+s);console.log("Rewritten relative to "+i+" = "+r);return n(t).attr("data-src",r)}return console.log("Image path already absolute: "+u)})}}return GENTICS.Utils.Dom.insertIntoDOM(r,s,e.activeEditable.obj)}});this.copybutton=r.adopt("copy",i,{click:function(e){e.preventDefault();return l.copySection(u)}});t=function(e){e=e.filter(function(){return!n(this).has(".copy-section-controls").length});return e.append('<div class="aloha-ephemera copy-section-controls"\n     contenteditable="false">\n  <span href="#" title="Copy section" class="copy-section"><i class="icon-copy"></i> Copy section</span>\n</div>')};return e.bind("aloha-editable-created",function(e,r){localStorage&&localStorage.alohaOerCopyBuffer?f.pastebutton.enable():f.pastebutton.disable();t(r.obj.find("h1,h2,h3"));r.obj.on("change-heading",function(e){return t(n(e.target))});return r.obj.on("click",".copy-section-controls .copy-section",function(e){return l.copySection(n(e.target).parent().parent())})})}})})}).call(this);