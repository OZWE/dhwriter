(function(){define(["aloha","jquery","aloha/plugin","image/image-plugin","ui/ui","semanticblock/semanticblock-plugin","css!assorted/css/image.css"],function(e,t,n,r,i,s){var o,u,a,f,l,c="/../plugins/oer/image/img/warning.png",h='<form class="plugin image modal hide fade" id="linkModal" tabindex="-1" role="dialog" aria-labelledby="linkModalLabel" aria-hidden="true" data-backdrop="false">\n  <div class="modal-header">\n    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\n    <h3>Insert image</h3>\n  </div>\n  <div class="modal-body">\n    <div class="image-options">\n        <div class="image-selection">\n          <div class="dia-alternative">\n            <span class="upload-image-link btn-link">Choose an image to upload</span>\n          </div>\n          <div class="dia-alternative">\n            OR\n          </div>\n          <div class="dia-alternative">\n            <span class="upload-url-link btn-link">get image from the Web</span>\n          </div>\n        </div>\n        <div class="placeholder preview hide">\n          <img class="preview-image"/>\n        </div>\n    </div>\n    <input type="file" class="upload-image-input" />\n    <input type="url" class="upload-url-input" placeholder="Enter URL of image ..."/>\n    <div class="image-alt">\n      <div class="forminfo">\n        <i class="icon-warning"></i><strong>Describe the image for someone who cannot see it.</strong> This description can be read aloud, making it possible for visually impaired learners to understand the content.\n      </div>\n      <div>\n        <textarea name="alt" type="text" placeholder="Enter description ..."></textarea>\n      </div>\n    </div>\n  </div>\n  <div class="modal-footer">\n    <button type="submit" disabled="true" class="btn btn-primary action insert">Save</button>\n    <button class="btn action cancel">Cancel</button>\n  </div>\n</form>',p=function(n){var r,i,s,o,u=this,l=e.require("assorted/assorted-plugin").settings,p=e.activeEditable.obj,d=t(h),v=d.find(".image-selection"),m=d.find(".placeholder.preview"),g=d.find(".upload-image-input").hide(),y=d.find(".upload-url-input").hide(),b=d.find(".action.insert"),w=n.attr("src"),E=n.attr("alt");w&&d.find(".action.insert").removeAttr("disabled");i=Boolean(w);d.find("[name=alt]").val(E);i&&d.find(".image-options").hide();(function(e,t){return e.onerror=function(){var n=t+c;if(e.src!==n)return e.src=n}})(d.find(".placeholder.preview img")[0],e.settings.baseUrl);o=function(e){w=e;return b.removeAttr("disabled")};s=function(e,t,n){var r=new FileReader;r.onloadend=function(){t&&t.attr("src",r.result);o(r.result);if(n)return n(r.result)};return r.readAsDataURL(e)};d.find(".upload-image-link").on("click",function(){m.hide();y.hide();g.click();return g.show()});d.find(".upload-url-link").on("click",function(){m.hide();g.hide();return y.show().focus()});g.on("change",function(){var e,t=g[0].files;if(t.length>0){if(l.image.preview){e=m.find("img");s(t[0],e);m.show();return v.hide()}return s(t[0])}});y.on("change",function(){var e=m.find("img"),t=y.val();o(t);if(l.image.preview){e.attr("src",t);m.show();return v.hide()}});r=$.Deferred();d.on("submit",function(e){var t;e.preventDefault();t=!n.attr("alt")&&d.find("[name=alt]").val();n.attr("src",w);n.attr("alt",d.find("[name=alt]").val());t?f(n.parent()):a(n.parent());r.resolve({target:n[0],files:g[0].files});n.parents(".media").removeClass("aloha-ephemera");return d.modal("hide")});d.on("click",".btn.action.cancel",function(e){e.preventDefault();i||n.parents(".semantic-container").remove();r.reject({target:n[0]});return d.modal("hide")});d.on("hidden",function(){r.state()==="pending"&&r.reject({target:n[0]});return d.remove()});return t.extend(!0,r.promise(),{show:function(e){e&&d.find(".modal-header h3").text(e);return d.modal("show")}})},d=function(){var e,n,r=this,i=$('<span class="media aloha-ephemera"><img /></span>');s.insertAtCursor(i);e=i.find("img");n=p(e);n.done(function(n){if(n.files.length){e.addClass("aloha-image-uploading");return r.uploadImage(n.files[0],e,function(r){r&&t(n.target).attr("src",r);return e.removeClass("aloha-image-uploading")})}});return n.show()};$("body").bind("aloha-image-resize",function(){return l(r.imageObj)});l=function(e){var t=e.parents(".image-wrapper");if(t.length)return t.css("width",e.css("width"))};f=function(e){var t=e.children(".image-edit");t.html('<i class="icon-edit"></i> Thank You!').removeClass("passive");t.css("background","lightgreen");return t.animate({backgroundColor:"white",opacity:0},2e3,"swing",function(){return a(e)})};a=function(e){var t=e.children("img").attr("alt"),n=e.children(".image-edit").css("opacity",1);if(t)return n.html('<i class="icon-edit"></i>').addClass("passive");n.html('<i class="icon-warning"></i><span class="warning-text">Description missing</span>').removeClass("passive");n.off("mouseenter").on("mouseenter",function(){return n.find(".warning-text").text("Image is missing a description for the visually impaired. Click to provide one.")});return n.off("mouseleave").on("mouseleave",function(){return n.find(".warning-text").text("Description missing")})};o=function(e){var t=$('<div class="image-wrapper">').css("width",e.css("width")),n=$('<div class="image-edit">'),r=e.find("img");e.children().remove();r.appendTo(e).wrap(t);a(e.children(".image-wrapper").prepend(n));return e.find("img").load(function(){return l($(this))})};u=function(e){var n,r,i,s=e.find("img");e.children().remove();e.append(s);e.attr("data-alt",s.attr("alt")||"");r=e.closest(".media");if(r.length>0){n=t(r[0]);i=n.parents("figure, .para, .equation, .note, .quote");i.length===0&&e.parents(".semantic-container").wrap('<p class="para">')}};return n.create("oer-image",{getLabel:function(){return"Image"},activate:o,deactivate:u,selector:".media",init:function(){var e=this;i.adopt("insertImage-oer",null,{click:function(t){return d.bind(e)(t)}});s.register(this);return s.registerEvent("click",".aloha-oer-block .image-edit",function(){var e=$(this).siblings("img"),t=p(e);return t.show("Edit image")})},uploadImage:function(t,n,r){var i,s=this,o=e.require("assorted/assorted-plugin").settings,u=new XMLHttpRequest;if(u.upload){if(!o.image.uploadurl)throw new Error("uploadurl not defined");u.onload=function(){var e;o.image.parseresponse?e=parseresponse(u):e=JSON.parse(u.response).url;return r(e)};u.open("POST",o.image.uploadurl,!0);u.setRequestHeader("Cache-Control","no-cache");if(o.image.uploadSinglepart){u.setRequestHeader("Content-Type","");u.setRequestHeader("X-File-Name",t.name);return u.send(t)}i=new FormData;i.append(o.image.uploadfield||"upload",t,t.name);return u.send(i)}}})})}).call(this);