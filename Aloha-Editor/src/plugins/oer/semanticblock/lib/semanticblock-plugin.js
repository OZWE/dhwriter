(function(){var e=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};define(["aloha","block/blockmanager","aloha/plugin","aloha/pluginmanager","jquery","aloha/ephemera","ui/ui","ui/button","copy/copy-plugin","css!semanticblock/css/semanticblock-plugin.css"],function(t,n,r,i,s,o,u,a,f){var l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N;if(i.plugins.semanticblock)return i.plugins.semanticblock;l='<div class="semantic-settings modal hide" id="linkModal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="false">\n  <div class="modal-header">\n    <h3></h3>\n  </div>\n  <div class="modal-body">\n    <div style="margin: 20px 10px 20px 10px; padding: 10px; border: 1px solid grey;">\n        <strong>Custom class</strong>\n        <p>\n            Give this element a custom "class". Nothing obvious will change in your document.\n            This is for advanced book styling and requires support from the publishing system.\n        </p> \n        <input type="text" placeholder="custom element class" name="custom_class">\n    </div>\n  </div>\n  <div class="modal-footer">\n    <button class="btn btn-primary action submit">Save changes</button>\n    <button class="btn action cancel">Cancel</button>\n  </div>\n</div>';m=s('<div class="semantic-container aloha-ephemera-wrapper"></div>');N=s('<div class="semantic-controls-top aloha-ephemera">\n  <a class="copy" title="Copy this element."><i class="icon-copy"></i> Copy element</button>\n</div>');p=s('<div class="semantic-controls aloha-ephemera">\n  <button class="semantic-delete" title="Remove this element."><i class="icon-remove"></i></button>\n  <button class="semantic-settings" title="advanced options."><i class="icon-cog"></i></button>\n</div>');d=s('<div class="semantic-drag-helper aloha-ephemera">\n    <div class="title"></div>\n    <div class="body">Drag me to the desired location in the document</div>\n</div>');T=[];b=null;x=[{name:"mouseenter",selector:".aloha-block-draghandle",callback:function(){return s(this).parents(".semantic-container").addClass("drag-active")}},{name:"mouseleave",selector:".aloha-block-draghandle",callback:function(){if(!s(this).parents(".semantic-container").is(".aloha-oer-dragging"))return s(this).parents(".semantic-container").removeClass("drag-active")}},{name:"mouseenter",selector:".semantic-delete",callback:function(){return s(this).parents(".semantic-container").first().addClass("delete-hover")}},{name:"mouseleave",selector:".semantic-delete",callback:function(){return s(this).parents(".semantic-container").removeClass("delete-hover")}},{name:"mousedown",selector:".aloha-block-draghandle",callback:function(e){e.preventDefault();return s(this).parents(".semantic-container").addClass("aloha-oer-dragging",!0)}},{name:"mouseup",selector:".aloha-block-draghandle",callback:function(){return s(this).parents(".semantic-container").removeClass("aloha-oer-dragging")}},{name:"click",selector:".semantic-container .semantic-delete",callback:function(){return s(this).parents(".semantic-container").first().slideUp("slow",function(){return s(this).remove()})}},{name:"click",selector:".semantic-container .semantic-controls-top .copy",callback:function(){var e=s(this).parents(".semantic-container").first();return f.buffer(e.outerHtml(),f.getCurrentPath())}},{name:"mouseover",selector:".semantic-container .semantic-controls-top .copy",callback:function(){var e=s(this).parents(".semantic-container");return e.removeClass("copy-preview").first().addClass("copy-preview")}},{name:"mouseout",selector:".semantic-container .semantic-controls-top .copy",callback:function(){return s(this).parents(".semantic-container").removeClass("copy-preview")}},{name:"click",selector:".semantic-container .semantic-settings",callback:function(){var e,t,n;if(s(".semantic-settings.modal:visible").length)return;t=s(l);t.modal("show");t.css({"margin-top":(s(window).height()-t.height())/2,top:"0"});e=s(this).parents(".semantic-controls").siblings(".aloha-oer-block");n=E(e);t.find("h3").text("Edit options for this "+n);t.find("[name=custom_class]").val(e.attr("data-class"));return t.data("element",e)}},{name:"click",selector:".modal.semantic-settings .action.cancel",callback:function(){var e=s(this).parents(".modal");return e.modal("hide")}},{name:"click",selector:".modal.semantic-settings .action.submit",callback:function(){var e,t=s(this).parents(".modal");t.modal("hide");e=t.data("element");e.attr("data-class",t.find("[name=custom_class]").val());if(e.attr("data-class")==="")return e.removeAttr("data-class")}},{name:"mouseover",selector:".semantic-container",callback:function(){var e,t;s(this).parents(".semantic-container").removeClass("focused");s(this).find(".focused").length||s(this).addClass("focused");t=s(this).children(".aloha-oer-block").first();e=t.length&&v(t);return s(this).find(".aloha-block-handle").attr("title","Drag this "+e+" to another location.")}},{name:"mouseout",selector:".semantic-container",callback:function(){return s(this).removeClass("focused")}},{name:"blur",selector:"[placeholder],[hover-placeholder]",callback:function(){var e=s(this);if(!e.text().trim()&&!e.find(".aloha-oer-block").length)return e.empty()}}];S=function(){};E=function(e){var t,n,r;for(n=0,r=T.length;n<r;n++){t=T[n];if(e.is(t.selector))return t.getLabel(e)}};v=function(e){var t,n,r,i=E(e);if(i)return r=i.toLowerCase();n=function(){var n,r,i=e.attr("class").split(/\s+/),s=[];for(n=0,r=i.length;n<r;n++){t=i[n];/^aloha/.test(t)||s.push(t)}return s}();return r=n.length&&"element (class='"+n.join(" ")+"')"||"element"};c=function(t){var n,r,i,o,u,a,f,l,c,h;if(!(t.is(".semantic-container")||t.is(".alternates")&&t.parents("figure").length)){t.addClass("aloha-oer-block");if(t.parent().is(".aloha-editable")){s('<p class="aloha-oer-ephemera-if-empty"></p>').insertBefore(t);s('<p class="aloha-oer-ephemera-if-empty"></p>').insertAfter(t)}l=null;for(c=0,h=T.length;c<h;c++){a=T[c];if(t.is(a.selector)){l=a;break}}i=p.clone();f=N.clone();o=v(t);i.find(".semantic-delete").attr("title","Remove this "+o+".");f.find(".copy").attr("title","Copy "+o+".");if(l!==null){if(l.options){typeof l.options=="function"?u=l.options(t):u=l.options;if(u.buttons){e.call(u.buttons,"settings")<0&&i.find("button.semantic-settings").remove();e.call(u.buttons,"copy")<0&&f.find("a.copy").remove()}}t.wrap(m).parent().append(i).prepend(f).alohaBlock();l.activate(t);return}t.wrap(m).parent().append(i).prepend(f).alohaBlock();t.children("[placeholder],[hover-placeholder]").andSelf().filter("[placeholder],[hover-placeholder]").each(function(){if(!s(this).text().trim())return s(this).empty()});r=t.children(".title").first();r.attr("hover-placeholder","Add a title");r.aloha();n=t.contents().not(r);return s("<div>").addClass("body aloha-block-dropzone").appendTo(t).aloha().append(n)}};w=function(e){var t,n,r,i,s;e.removeClass("aloha-oer-block ui-draggable");e.removeAttr("style");for(i=0,s=T.length;i<s;i++){r=T[i];if(e.is(r.selector)){r.deactivate(e);return}}t=e.children(".title").first().mahalo().removeClass("aloha-editable aloha-block-blocklevel-sortable ui-sortable").removeAttr("hover-placeholder");n=e.children(".body");n.is(":empty")?n.remove():e.children(".body").contents().unwrap();return e.attr("data-unknown","true")};h=function(e){var t,n,r;if(e.data("oerBlocksInitialized"))return;e.data("oerBlocksInitialized",!0);t=void 0;n=void 0;n=0;r=[];while(n<x.length){t=x[n];e.on(t.name,t.selector,t.callback);r.push(n++)}return r};g=function(e){var t,n,r,i,o,u=e.find("[id]"),a={},f=[];for(n=i=0,o=u.length;0<=o?i<=o:i>=o;n=0<=o?++i:--i){t=s(u[n]);r=t.attr("id");a[r]?f.push(t.attr("id","")):f.push(a[r]=t)}return f};y=function(e){return e.find(".aloha-oer-ephemera-if-empty").each(function(){var e=s(this);return e.text().trim().length?e.removeClass("aloha-oer-ephemera-if-empty"):e.remove()})};t.ready(function(){return h(s(document))});return r.create("semanticblock",{defaults:{defaultSelector:"div:not(.title,.aloha-oer-block,.aloha-editable,.aloha-block,.aloha-ephemera-wrapper,.aloha-ephemera)"},makeClean:function(e){e.find(".semantic-container").each(function(){if(s(this).children().not(".semantic-controls").length===0)return s(this).remove()});e.find(".aloha-oer-block").each(function(){return w(s(this))});g(e);return y(e)},init:function(){var e=this;o.ephemera().pruneFns.push(function(e){return s(e).removeClass("aloha-block-dropzone aloha-editable-active aloha-editable aloha-block-blocklevel-sortable ui-sortable").removeAttr("contenteditable placeholder").get(0)});return t.bind("aloha-editable-created",function(t,n){var r,i,o,u,a,f=n.obj,l=[];for(u=0,a=T.length;u<a;u++){o=T[u];l.push(o.selector)}r=e.settings.defaultSelector+","+l.join();i=setInterval(function(){if(f.data("sortable")){clearInterval(i);f.sortable("option","stop",function(e,t){f=s(t.item);if(f.is(r))return c(f)});f.sortable("option","placeholder","aloha-oer-block-placeholder aloha-ephemera")}return 100});if(f.is(".aloha-root-editable")){f.find(r).each(function(){if(!s(this).parents(".semantic-drag-source").length)return c(s(this))});return s(".semantic-drag-source").children().each(function(){var e=s(this),t=(e.data("type")||e.attr("class")).split(" ")[0];return e.draggable({connectToSortable:f,appendTo:s("body"),revert:"invalid",helper:function(){var e=s(d).clone();e.find(".title").text(t);return e},start:function(e,t){f.addClass("aloha-block-dropzone");return s(t.helper).addClass("dragging")},refreshPositions:!0})})}})},insertAtCursor:function(e){var n=s(e),r=t.Selection.getRangeObject();n.addClass("semantic-temp");GENTICS.Utils.Dom.insertIntoDOM(n,r,t.activeEditable.obj);n=t.jQuery(".semantic-temp").removeClass("semantic-temp");return c(n)},appendElement:function(e,n){e.addClass("semantic-temp");n.append(e);e=t.jQuery(".semantic-temp").removeClass("semantic-temp");return c(e)},register:function(e){T.push(e);if(e.ignore)return this.settings.defaultSelector+=":not("+e.ignore+")"},registerEvent:function(e,t,n){return x.push({name:e,selector:t,callback:n})}})})}).call(this);