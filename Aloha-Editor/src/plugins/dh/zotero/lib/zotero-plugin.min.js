define(["aloha","jquery","overlay/overlay-plugin","aloha/plugin","ui/ui","ui/toggleButton","util/dom","PubSub","i18n!zotero/nls/i18n","i18n!aloha/nls/i18n"],function(e,t,n,r,i,s,o,u,a){"use strict";function y(){var e=[],n=c;t.each(arguments,function(){e.push(""===this?n:n+"-"+this)});return t.trim(e.join(" "))}function b(e){var t=e;while(t){if(t.nodeName.toLowerCase()==="cite")return t;t=t.parentNode}return!1}var f=t,l=window.GENTICS,c="aloha-zotero",h=(new Date).getTime(),p='<form class="modal" id="zoteroModal" tabindex="-1" role="dialog" aria-labelledby="zoteroModalLabel" aria-hidden="true">      <div class="modal-header">        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>        <h3 id="zoteroModalLabel">Reference</h3>      </div>      <div class="modal-body tabs">		<ul>			<li><a href="#tabs-1">Manual Input</a></li>			<li><a href="#tabs-2">My Library</a></li>		</ul>		<div id="tabs-1">	        <div>	          <span>Title</span>	          <div>	            <input id="zotero-title" class="input-xlarge" type="text" placeholder="Enter full citation reference here" required />	          </div>	        </div>        </div>		<div id="tabs-2">        </div>      </div>      <div class="modal-footer">        <button class="btn btn-primary zotero-save">Save</button>        <button class="btn zotero-delete" data-dismiss="modal" aria-hidden="true">Delete</button>      </div>    </form>',d='<div class="aloha-ephemera tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',v="ref-uid-",m="citation-",g={quote:y("quote"),blockquote:y("blockquote"),"link-field":y("link-field"),"note-field":y("note-field"),references:y("references")};return r.create("zotero",{citations:[],referenceContainer:null,settings:null,config:["cite"],init:function(){var n,r,s=this;if(e.settings&&e.settings.plugins&&e.settings.plugins.zotero){n=t(e.settings.plugins.zotero.referenceContainer);n.length&&(s.referenceContainer=n);typeof e.settings.plugins.zotero!="undefined"&&(s.settings=e.settings.plugins.zotero)}this._quoteButton=i.adopt("zotero",null,{tooltip:a.t("zotero.button.add.quote"),scope:"Aloha.continuoustext",click:function(){var n,r,i,o=e.activeEditable,u=e.Selection.getRangeObject();if(u.startContainer!==u.endContainer)return;r=b(u.startContainer);if(r){n=t(r);u.startContainer=u.endContainer=r;u.startOffset=0;u.endOffset=r.childNodes.length}else{u.select();n=s.addInlineQuote()}i=s.showModalDialog(n);return i.on("hidden",function(){})}});r=this;e.ready(function(){setTimeout(function(){r.reloadCitations(r)},1e3)});e.bind("aloha-editable-activated",function(e,t){var n=s.getEditableConfig(t.editable.obj);if(!n)return;s._quoteButton.show(!0)});e.bind("aloha-editable-created",function(n,r){t(r.obj).on("click","cite",function(n){var r,i=t(this);i.contentEditable(!1);r=new l.Utils.RangeObject;r.startContainer=r.endContainer=i[0];r.startOffset=r.endOffset=0;e.Selection.rangeObject=r;e.trigger("aloha-selection-changed",[r,n]);n.stopPropagation();s.showModalDialog(i)});return t.ui&&t.ui.tooltip?r.obj.tooltip({items:"cite",content:function(){return"Click to edit reference"},template:d}):r.obj.tooltip({selector:"cite",placement:"top",title:"Click to edit reference",trigger:"hover",template:d})});e.bind("aloha-selection-changed",function(){s._quoteButton.show(e.Selection.rangeObject.startOffset===e.Selection.rangeObject.endOffset)});u.sub("aloha.selection.context-change",function(n){var r,i,o=n.range,u=t("button.aloha-zotero-button"),a=!1,f=o.markupEffectiveAtStart,l=f.length;while(l){r=f[--l].nodeName;if(r==="CITE"){a=!0;break}}u.filter(".aloha-zotero-block-button").removeClass("aloha-zotero-pressed");s._quoteButton.setState(!1);if(a){s._quoteButton.setState(!0);return!1}i=[];e.activeEditable&&(i=s.getEditableConfig(e.activeEditable.obj));s._quoteButton.show(e.Selection.rangeObject.startOffset===e.Selection.rangeObject.endOffset)})},reloadCitations:function(n){var r,i=e.getEditableById("canvas");if(i===null)setTimeout(function(){n.reloadCitations(n)},1e3);else{n.citations.splice();n.prepareRefContainer();r=i.getContents();t(r).find("cite").each(function(){var e,t=f(this).attr("id").substring(m.length);if(t!="undefined"){e=f(this).children("span").html();n.addRefLineToContainer(t,"#",e);n.citations.push({uid:t,reference:null})}})}},showModalDialog:function(n){var r,i,s,o=this,u=e.activeEditable.obj,a=t(p);a.attr("data-backdrop",!1);r=n.get(0);i=a.find("#zotero-title");s=a.find(".zotero-save");a.find(".tabs").tabs();a.find("#zotero-title").val(n.children("span").html()).autocomplete({source:"/_.php?f=getCitations&",minLength:2,autoFocus:!0}).on("autocompleteselect",function(e,t){o.addCiteDetails(h,t.item.value)});a.find("input, textarea").bind("keyup change",function(){o.addCiteDetails(h,i.val())});a.on("submit",function(e){var t;e.preventDefault();i.val()&&i.val().trim()&&n.html("<span>"+i.val().trim()+"</span>");t=a.find(".link-input[required]");n.attr("href",t.val());f.get("_.php",{f:"addCitation",label:i.val().trim()});return a.modal("hide")});a.on("click",".btn.zotero-delete",function(){var e=n.text();n.replaceWith("");o.reloadCitations(o)});a.modal("show");a.on("hidden",function(){return a.remove()});return a},getIndexOfCitation:function(e){var t,n,r=this.citations,i=r.length,s=0;while(s<i){t=s+i>>1;n=r[t].uid;if(n==e)return t;n>e?i=t:n<e&&(s=t+1)}return-1},addInlineQuote:function(){var n,r=[y("wrapper"),y(++h)].join(" "),i=t('<cite class="'+r+'" id="'+m+h+'" data-reference-id="'+h+'"><span></span></cite>'),s=e.Selection.rangeObject;if(s!=="undefined"){n=this.getIndexOfCitation(h);-1===n&&(n=this.citations.push({uid:h,reference:""})-1);e.activeEditable&&t(e.activeEditable.obj[0]).click();o.insertIntoDOM(i,s,f(e.activeEditable.obj),!0);s.select();this.referenceContainer&&this.reloadCitations(this);return i}return!1},prepareRefContainer:function(){this.referenceContainer.html('<ol class="references"></ol>')},addRefLineToContainer:function(e,t,n){this.referenceContainer.find("ol.references").append('<li id="'+v+e+'"><a href="'+t+'"><span>'+n+"</span></a></li>")},addCiteDetails:function(e,n){this.citations[this.getIndexOfCitation(e)]={uid:e,reference:n};if(this.referenceContainer){t("li#"+v+e+" span").html(n);t("cite#"+m+e).children("span").html(n)}},makeClean:function(e){e.find("cite").each(function(){t.trim(t(this).attr("class"))===""&&t(this).removeAttr("class");if(!this.referenceContainer){t(this).removeClass("aloha-zotero-"+t(this).attr("data-zotero-id"));t(this).attr("data-zotero-id")!=null&&t(this).removeAttr("data-zotero-id")}t(this).removeClass("aloha-zotero-wrapper")})}})});